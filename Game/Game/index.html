<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title>SpriteGame Development</title>
    <script src="js/jquery-2.1.0.min.js"></script>
</head>
<body>
    <div class="output"></div>

    <canvas id="canvas"></canvas>
    <script>

        function Renderer(__canvas, __config)
        {
            // Default Config
            var _config = {
                debug: true,
                width: 800,
                height: 300,
                tileSize: 25,
                elementsPath: "map/elements.json",
                mapPath: "map/map2.json",
                showBlocking: true
            };

            // Variables
            var _canvas;
            var _ctx;

            var _width = 0;
            var _height = 0;

            var _elements = {};
            var _map = [];

            var _offset = {
                x: 0,
                y: 0
            }


            // Constructor ---------

            var _init = function ()
            {
                _canvas = __canvas;
                _config = $.extend(_config, __config);

                _width = _config.width;
                _height = _config.height;
                _ctx = _canvas.getContext("2d")

                $(_canvas)
                    .attr("width", _width)
                    .attr("height", _height);

                _loadConfig();
                _loadMap();

            }


            // ---- Config Handler ----

            var _loadConfig = function ()
            {
                _log("Load Config from path: ", _config.elementsPath);

                var result = _getFile(_config.elementsPath);

                $.each(result, function (_, el)
                {
                    _elements[el.ID] = el;
                });

                _log("Element Definitions loaded: ", _elements);

            }

            var _loadMap = function ()
            {
                _log("Load Map from path:", _config.mapPath);

                var result = _getFile(_config.mapPath);

                for (y = 0; y < result.length; y++)
                {
                    var collom = result[y];

                    for (x = 0; x < collom.length; x++)
                    {
                        result[y][x] = _updateTile(result[y][x]);
                    }

                }
                _map = result;

                _log("Map Loaded: ", _map);


            }

            var _updateTile = function (tile)
            {
                if ((tile.BottomElementID !== undefined) && (tile.BottomElementID != null) && (tile.BottomElementID != ""))
                {
                    if (_elements[tile.BottomElementID] !== undefined)
                    {
                        tile.BottomElement = _elements[tile.BottomElementID];
                    }
                    else
                    {
                        _warn("Warning: No Element definintion '" + tile.BottomElementID + "' for Tile: ", tile);
                    }
                }

                if ((tile.MiddleElementID !== undefined) && (tile.MiddleElementID != null) && (tile.MiddleElementID != ""))
                {
                    if (_elements[tile.MiddleElementID] !== undefined)
                    {
                        tile.MiddleElement = _elements[tile.MiddleElementID];
                    }
                    else
                    {
                        _warn("Warning: No Element definintion '" + tile.MiddleElementID + "' for Tile: ", tile);
                    }
                }

                if ((tile.TopElementID !== undefined) && (tile.TopElementID != null) && (tile.TopElementID != ""))
                {
                    if (_elements[tile.TopElementID] !== undefined)
                    {
                        tile.TopElement = _elements[tile.TopElementID];
                    }
                    else
                    {
                        _warn("Warning: No Element definintion '" + tile.TopElementID + "' for Tile: ", tile);
                    }
                }


                return tile;
            }

            var _renderMap = function()
            {
                //_log("Map rendering ...");

                for (collom = 0; collom < _map.length; collom ++)
                {
                    //_log("Row: ", collom);

                    var yOffset = collom * _config.tileSize - _offset.y;

                    for (element = 0; element < _map[collom].length; element ++)
                    {
                        //_log("Element: ", element);

                        var xOffset = element * _config.tileSize - _offset.x;

                        _map[collom][element].X = xOffset;
                        _map[collom][element].Y = yOffset;

                        if ((((xOffset + _config.tileSize) < 0) || ((yOffset + _config.tileSize) < 0)) || ((xOffset > _width) || (yOffset > _height)))
                        {
                            //_log("Tile out of sight: ", _map[collom][element]);
                            continue;
                        }

                        _addTile(_map[collom][element], xOffset, yOffset, false);
                    }


                }

            }



            // -------------

            this.test = function (offset)
            {
                _clear();


                _offset.x = offset;
                _offset.y = 0;

                _renderMap();




            }




            // --- Draw Functions ----
            var _clear = function ()
            {
                _ctx.rect(0, 0, _width, _height);
                _ctx.fillStyle = 'green';
                _ctx.fill();
            }

            var _addTile = function (tile, x, y, ignoreOutOfSight)
            {
                //_log("Render Tile: ", tile);

                var bottom = tile.BottomElement;
                var middle = tile.MiddleElement;
                var top = tile.TopElement;

                var topCallback = function ()
                {
                    if ((_config.showBlocking) && (!tile.Passable))
                    {
                        _ctx.strokeStyle = "#f00";
                        _ctx.strokeRect(x, y, _config.tileSize, _config.tileSize);
                    }
                }

                var middleCallback = function ()
                {
                    if (top != undefined)
                    {
                        _addImage(top.ImageURI, x, y, undefined, undefined, topCallback, ignoreOutOfSight);
                    }
                }

                var bottomCallback = function ()
                {
                    if (middle !== undefined)
                    {
                        _addImage(middle.ImageURI, x, y, undefined, undefined, middleCallback, ignoreOutOfSight);
                    }
                    else if (top !== undefined)
                    {
                        _addImage(top.ImageURI, x, y, undefined, undefined, topCallback, ignoreOutOfSight);
                    }

                }

                _addImage(bottom.ImageURI, x, y, undefined, undefined, bottomCallback, ignoreOutOfSight);


            }

            var _addImage = function (src, x, y, width, height, imageOnLoad, ignoreOutOfSight)
            {
               // _log("Add Image '" + src + "' at: ", { x: x, y: y });

                ignoreOutOfSight = (ignoreOutOfSight === undefined) ? false : Boolean(ignoreOutOfSight);

                if (!ignoreOutOfSight && ((((x + width) < 0) && ((y + height) < 0)) || ((x > _width) && (y > _height))))
                {
                   // _log("Out of sight!");
                    return;
                }

                var imageObj = new Image();

                if (typeof (width) == "undefined")
                {
                    width = _config.tileSize;
                }

                if (typeof (height) == "undefined")
                {
                    height = _config.tileSize;
                }

                imageObj.onload = function ()
                {

                    _ctx.drawImage(imageObj, x, y, width, height);

                    if (typeof (imageOnLoad) != undefined)
                    {
                        imageOnLoad({
                            x: x,
                            y: y,
                            width: width,
                            height: height,
                            image: imageObj
                        });
                    }

                    /*if (_ShowBlocking && config.blocking)
                    {

                        _ctx.strokeStyle = "#f00";
                        _ctx.strokeRect(x, y, width, height);
                    }
                    */
                };

                imageObj.src = src;
            }


            // --- Helper Functions ----

            var _getFile = function (url, callback, dataType)
            {
                var async = (!(typeof (callback) == "undefined"));
                dataType = (typeof (dataType) == "undefined") ? "json" : dataType;

                var tempResult = null;

                $.ajax({
                    dataType: dataType,
                    url: url,
                    success: function (result)
                    {
                        if (async)
                        {
                            callback(result);
                        }
                        else
                        {
                            tempResult = result;
                        }

                    },
                    async: async
                });


                return tempResult;
            }

            var _log = function (message, objects)
            {
                if (_config.debug)
                {
                    console.log(message, objects);
                }
            }

            var _info = function (message, objects)
            {
                if (_config.debug)
                {
                    console.info(message, objects);
                }
            }

            var _warn = function (message, objects)
            {
                if (_config.debug)
                {
                    console.warn(message, objects);
                }
            }

            var _error = function (message, objects)
            {
                if (_config.debug)
                {
                    console.error(message, objects);
                }
            }


            // -------
            _init();
        }

        var render = new Renderer($("#canvas")[0]);

        var run = true;
        var offset = 0;
        

        $(document).ready(function ()
        {

            window.setInterval(function ()
            {
                if (run)
                {
                    offset += 5;
                    if (offset > 600)
                    {
                        offset = 0;
                    }


                    render.test(offset);
                }
            }, 100);

            //render.test();
        });



    </script>

</body>
</html>